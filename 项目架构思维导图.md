# @d5techs/3dgs-lib

## 项目概述

### 核心定位

- 可扩展的 WebGPU 3D 渲染引擎
- 核心特性：3D Gaussian Splatting (3DGS) 技术
- 基于现代 Web 技术栈
- 支持桌面端和移动端

### 主要功能

- WebGPU 高性能渲染
- 3D Gaussian Splatting 支持
  - PLY / Splat 文件加载
  - GPU 加速排序（Radix Sort）
  - 球谐函数 (SH) L0/L1/L2/L3
- 多格式模型加载
  - GLB/GLTF 模型
  - OBJ/MTL 模型（支持材质和纹理）
- 完整交互系统
  - 轨道控制器 (OrbitControls)
  - 变换 Gizmo（平移/旋转/缩放）
  - 视口坐标轴指示器
  - 选中对象包围盒显示
- 场景管理
  - 多对象管理
  - 材质颜色编辑
  - 自动 Frame Model 功能
- 移动端支持
  - 触摸手势控制
  - 自动性能优化
  - 响应式 UI

### 技术亮点

- 移动端纹理压缩优化
  - 内存占用从 256 bytes/splat 降至 ~36 bytes/splat
  - 支持更大规模点云渲染
- 自适应性能等级检测
- GPU Compute Shader 加速排序
- 多级球谐函数光照

## 技术架构

### 技术栈

- 语言：TypeScript 5.3+
- 图形 API：WebGPU
- 着色器语言：WGSL (WebGPU Shading Language)
- 构建工具：Vite 5.0
- 测试框架：Vitest
- 包管理：Yarn

### 浏览器支持

- Chrome 113+
- Edge 113+
- Safari 17+
- Firefox（实验性支持）
- 要求：HTTPS 或 localhost 环境

### 系统要求

- Node.js 18+（开发环境）
- 支持 WebGPU 的现代浏览器
- GPU 硬件加速

## 项目结构

### 根目录结构

```
@d5techs/3dgs-lib/
├── src/                    # 引擎源代码
├── demo/                   # Demo 应用
├── dist/                   # 构建输出
├── package.json
├── tsconfig.json
├── tsconfig.build.json
├── vite.config.ts          # Demo 构建配置
├── vite.lib.config.ts      # 库构建配置
├── vitest.config.ts        # 测试配置
├── README.md
└── USAGE_GUIDE.md
```

### 核心模块 (src/)

#### 入口文件

- `index.ts` - 库入口，导出所有公共 API
- `App.ts` - 统一调度入口类

#### core/ - 核心模块

- `Renderer.ts` - WebGPU 渲染器
  - 设备管理
  - 渲染通道
  - 帧提交
- `Camera.ts` - 相机系统
  - 视图矩阵
  - 投影矩阵
  - 透视相机
- `OrbitControls.ts` - 轨道控制器
  - 鼠标/触摸交互
  - 相机旋转/平移/缩放
  - 视图切换动画
- `ViewportGizmo.ts` - 视口坐标轴指示器
  - 坐标轴显示
  - 视角切换
- `BoundingBoxRenderer.ts` - 包围盒渲染器
  - 选中对象高亮
  - 动态跟随（Provider 模式）

#### core/gizmo/ - 变换 Gizmo 模块

- `TransformGizmoV2.ts` - 变换 Gizmo
  - 平移/旋转/缩放模式
  - 射线拾取交互
  - 屏幕空间恒定大小
- `Shape.ts` - 形状基类
- `ArrowShape.ts` - 箭头形状（平移轴）
- `PlaneShape.ts` - 平面形状（平移平面）
- `ArcShape.ts` - 圆弧形状（旋转环）
- `SphereShape.ts` - 球体形状（中心点）
- `BoxLineShape.ts` - 方块线形状（缩放轴）
- `index.ts` - 模块导出

#### core/math/ - 数学工具

- `Vec3.ts` - 三维向量
- `Mat4.ts` - 4x4 矩阵
- `Quat.ts` - 四元数
- `Ray.ts` - 射线

#### scene/ - 场景管理模块

- `SceneManager.ts` - 场景管理器
  - Mesh 管理
  - Splat 管理
  - Bounding Box 查询
  - 材质颜色管理
  - SH 模式控制

#### interaction/ - 交互管理模块

- `GizmoManager.ts` - Gizmo 交互管理器
  - TransformGizmoV2 管理
  - ViewportGizmo 管理
  - BoundingBox 渲染
  - 代理对象创建
    - `SplatTransformProxy` - Splat 变换代理
    - `MeshGroupProxy` - Mesh 组变换代理
    - `SplatBoundingBoxProvider` - Splat 包围盒提供者

#### gs/ - 3D Gaussian Splatting 模块

- `IGSSplatRenderer.ts` - 渲染器统一接口
  - 定义桌面端/移动端共同接口
  - 类型定义：BoundingBox, SHMode, RendererCapabilities
- `GSSplatRenderer.ts` - Splat 渲染器（桌面端）
  - 实现 IGSSplatRenderer 接口
  - 完整 SH 支持
  - 高质量渲染
  - PerformanceTier 性能等级
- `GSSplatRendererMobile.ts` - Splat 渲染器（移动端）
  - 实现 IGSSplatRenderer 接口
  - 纹理压缩优化
  - 低内存占用
- `GSSplatSorter.ts` - GPU 排序器（桌面端）
  - Radix Sort 算法
  - Compute Shader 实现
- `GSSplatSorterMobile.ts` - GPU 排序器（移动端）
  - 优化的排序策略
- `PLYLoader.ts` - PLY 文件加载器（标准）
- `PLYLoaderMobile.ts` - PLY 文件加载器（移动端优化）
  - `parsePLYBuffer()` - 解析 PLY 缓冲区
  - `compactDataToGPUBuffer()` - 压缩数据到 GPU
- `SplatLoader.ts` - Splat 格式加载器
  - `loadSplat()` - 加载 Splat 文件
  - `deserializeSplat()` - 反序列化 Splat 数据
- `TextureCompressor.ts` - 纹理压缩工具
  - `compressSplatsToTextures()` - 压缩到纹理
  - `destroyCompressedTextures()` - 销毁纹理
  - `calculateTextureDimensions()` - 计算纹理尺寸
- `*.wgsl` - WGSL 着色器文件
  - `gs.wgsl` - 主渲染着色器
  - `gs_culling.wgsl` - 剔除着色器
  - `gs_sort.wgsl` - 排序着色器

#### mesh/ - 网格渲染模块

- `Mesh.ts` - 网格数据结构
  - 顶点/索引数据
  - 变换（位置/旋转/缩放）
  - 包围盒计算
- `MeshRenderer.ts` - 网格渲染器
  - 批量渲染
  - 材质管理

#### loaders/ - 加载器模块

- `GLBLoader.ts` - GLB/GLTF 加载器
  - 材质解析
  - 测试几何体创建
- `OBJLoader.ts` - OBJ 加载器
- `OBJParser.ts` - OBJ 解析器
- `OBJParser.test.ts` - OBJ 解析器测试
- `MTLParser.ts` - MTL 材质解析器
- `MTLParser.test.ts` - MTL 解析器测试

### Demo 应用 (demo/)

- `index.html` - 入口 HTML
- `main.ts` - Demo 主逻辑
  - 场景管理
  - UI 交互
  - 文件拖放
  - 性能监控

## 核心 API

### App 类（统一入口）

#### 初始化

```typescript
const app = new App(canvas);
await app.init();
app.start();
app.stop();
app.destroy();
```

#### 模型加载

```typescript
// 加载 PLY（3DGS）- 自动检测设备类型
await app.addPLY(url, onProgress?);

// 加载 Splat 格式
await app.addSplat(url, onProgress?);

// 加载 GLB 模型
await app.addGLB(url);

// 加载 OBJ 模型
await app.addOBJ(url);

// 添加测试几何体
app.addTestCube();
app.addTestSphere();
```

#### 场景管理

```typescript
// Mesh 管理
app.getMeshCount();
app.getMeshByIndex(index);
app.getMeshRange(startIndex, count);
app.removeMeshByIndex(index);
app.clearMeshes();

// Splat 管理
app.getSplatCount();
app.clearSplats();

// 材质颜色
app.getMeshColor(index);
app.setMeshColor(index, r, g, b, a);
app.setMeshRangeColor(startIndex, count, r, g, b, a);
```

#### Splat 变换

```typescript
app.setSplatPosition(x, y, z);
app.getSplatPosition();
app.setSplatRotation(x, y, z);
app.getSplatRotation();
app.setSplatScale(x, y, z);
app.getSplatScale();
app.getSplatBoundingBox();
```

#### SH 模式

```typescript
app.setSHMode(mode); // 0-3
app.getSHMode();
```

#### 相机控制

```typescript
app.frameCurrentModel(animate?);
app.getCamera();
app.getControls();
```

#### Gizmo 交互

```typescript
import { GizmoMode } from '@d5techs/3dgs-lib';

app.setGizmoMode(GizmoMode.Translate);
app.setGizmoMode(GizmoMode.Rotate);
app.setGizmoMode(GizmoMode.Scale);

app.setGizmoTarget(object);
app.getTransformGizmo();
app.getViewportGizmo();

// 代理对象
app.getSplatTransformProxy();
app.createMeshGroupProxy(startIndex, count);
app.createSplatBoundingBoxProvider();

// 包围盒显示
app.setSelectionBoundingBox(box);
app.setSelectionBoundingBoxProvider(provider);
app.clearSelectionBoundingBox();
```

#### 子系统访问

```typescript
app.getRenderer();
app.getMeshRenderer();
app.getGSRenderer();
app.getGSRendererMobile();
app.isUsingMobileRenderer();
```

### 导出的核心类

#### 渲染核心

| 类名 | 说明 |
|------|------|
| `App` | 统一调度入口 |
| `Renderer` | WebGPU 设备管理 |
| `Camera` | 透视相机 |
| `OrbitControls` | 轨道控制器 |
| `ViewportGizmo` | 视口指示器 |
| `BoundingBoxRenderer` | 包围盒渲染器 |

#### 网格系统

| 类名 | 说明 |
|------|------|
| `Mesh` | 网格数据结构 |
| `MeshRenderer` | 网格渲染器 |
| `GLBLoader` | GLB/GLTF 加载器 |
| `OBJLoader` | OBJ 加载器 |
| `OBJParser` | OBJ 解析器 |
| `MTLParser` | MTL 材质解析器 |

#### 3DGS 系统

| 类名 | 说明 |
|------|------|
| `GSSplatRenderer` | Splat 渲染器（桌面端） |
| `GSSplatRendererMobile` | Splat 渲染器（移动端） |
| `GSSplatSorter` | GPU 排序器（桌面端） |
| `GSSplatSorterMobile` | GPU 排序器（移动端） |
| `loadPLY` | PLY 加载函数 |
| `loadPLYMobile` | 移动端 PLY 加载函数 |
| `loadSplat` | Splat 加载函数 |

#### 场景与交互

| 类名 | 说明 |
|------|------|
| `SceneManager` | 场景管理器 |
| `GizmoManager` | Gizmo 交互管理器 |
| `TransformGizmoV2` | 变换 Gizmo |
| `SplatTransformProxy` | Splat 变换代理 |
| `MeshGroupProxy` | Mesh 组变换代理 |
| `SplatBoundingBoxProvider` | Splat 包围盒提供者 |

### 导出的类型定义

```typescript
// 进度回调
type ProgressCallback = (progress: number, stage: 'download' | 'parse' | 'upload') => void;

// 包围盒
interface BoundingBox {
  min: [number, number, number];
  max: [number, number, number];
  center: [number, number, number];
  radius: number;
}

// Gizmo 模式
enum GizmoMode {
  Translate = 'translate',
  Rotate = 'rotate',
  Scale = 'scale'
}

// SH 模式
type SHMode = 0 | 1 | 2 | 3;

// 性能等级
enum PerformanceTier {
  HIGH = 'high',
  MEDIUM = 'medium',
  LOW = 'low'
}

// 可变换对象接口
interface TransformableObject {
  position: [number, number, number];
  rotation: [number, number, number];
  scale: [number, number, number];
  setPosition(x: number, y: number, z: number): void;
  setRotation(x: number, y: number, z: number): void;
  setScale(x: number, y: number, z: number): void;
}

// 包围盒提供者接口
interface BoundingBoxProvider {
  getBoundingBox(): BoundingBox | null;
}
```

## 技术实现细节

### 3D Gaussian Splatting 原理

#### 数据结构

- 位置 (position)
- 缩放 (scale)
- 旋转 (rotation)
- 颜色 (color)
- 球谐系数 (SH coefficients)

#### 渲染流程

1. 协方差矩阵计算
   - 3D 协方差投影到 2D 屏幕空间
2. GPU 排序
   - Radix Sort 算法
   - Compute Shader 实现
3. 基于 Quad 的渲染
   - 2D 高斯椭圆投影
4. Alpha 混合
   - 深度排序后混合

#### 球谐函数 (SH)

| 模式 | 说明 | 性能 | 质量 |
|------|------|------|------|
| L0 | 仅 DC 颜色 | 最快 | 基础 |
| L1 | DC + L1 SH | 快 | 良好 |
| L2 | DC + L1 + L2 SH | 中等 | 高 |
| L3 | 完整 SH | 较慢 | 最高 |

### 移动端优化策略

#### 纹理压缩

- 原理：将 Splat 数据存储在纹理中
- 内存优化
  - 标准格式：256 bytes/splat
  - 压缩格式：~36 bytes/splat
  - 压缩比：约 7:1
- 实现：TextureCompressor 模块

#### 性能等级检测

- HIGH：桌面高端 GPU
- MEDIUM：桌面中端 GPU
- LOW：所有移动设备
- 检测依据
  - 设备类型（UA + 触摸屏）
  - GPU Buffer 大小限制
  - 强制移动设备使用 LOW

### WebGPU 渲染管线

#### 初始化流程

1. 检查 WebGPU 支持
2. 请求 GPU 适配器
3. 创建 GPU 设备
4. 配置 Canvas 上下文
5. 创建深度纹理

#### 渲染循环

```typescript
function render() {
  camera.updateMatrix();
  const pass = renderer.beginFrame();
  
  // 渲染 3D Gaussian Splatting
  gsRenderer?.render(pass);
  
  // 渲染网格
  meshRenderer.render(pass);
  
  // 渲染 Gizmo
  gizmoManager.render(pass);
  
  renderer.endFrame();
}
```

## 开发者使用指南

### 快速开始

#### 安装

```bash
# 使用 yarn
yarn add @d5techs/3dgs-lib

# 或使用 npm
npm install @d5techs/3dgs-lib
```

#### 开发

```bash
# 安装依赖
yarn install

# 启动开发服务器
yarn dev

# 构建库
yarn build:lib

# 构建 Demo
yarn build:demo

# 运行测试
yarn test
```

### 基本用法示例

#### 最简单的使用

```typescript
import { App } from '@d5techs/3dgs-lib';

const canvas = document.getElementById('canvas') as HTMLCanvasElement;
const app = new App(canvas);

await app.init();
await app.addPLY('path/to/model.ply');
app.frameCurrentModel();
app.start();
```

#### 使用单独模块

```typescript
import {
  Renderer,
  Camera,
  OrbitControls,
  GSSplatRenderer,
  loadPLY,
} from '@d5techs/3dgs-lib';

const renderer = new Renderer(canvas);
await renderer.init();

const camera = new Camera();
camera.setAspect(canvas.width / canvas.height);

const controls = new OrbitControls(camera, canvas);

const splats = await loadPLY('model.ply');
const gsRenderer = new GSSplatRenderer(renderer, camera);
gsRenderer.setData(splats);

function render() {
  const pass = renderer.beginFrame();
  gsRenderer.render(pass);
  renderer.endFrame();
  requestAnimationFrame(render);
}
render();
```

#### 带进度回调的加载

```typescript
await app.addPLY('large-model.ply', (progress, stage) => {
  console.log(`${stage}: ${progress.toFixed(1)}%`);
  // stage: 'download' | 'parse' | 'upload'
});
```

#### Gizmo 交互

```typescript
import { GizmoMode } from '@d5techs/3dgs-lib';

// 设置 Gizmo 模式
app.setGizmoMode(GizmoMode.Translate);

// 为 Splat 创建变换代理
const splatProxy = app.getSplatTransformProxy();
if (splatProxy) {
  app.setGizmoTarget(splatProxy);
  
  // 显示包围盒
  const provider = app.createSplatBoundingBoxProvider();
  app.setSelectionBoundingBoxProvider(provider);
}
```

### 交互控制

#### 鼠标操作

| 操作 | 功能 |
|------|------|
| 左键拖拽 | 旋转视角 |
| 右键拖拽 | 平移视角 |
| 滚轮 | 缩放 |

#### 触摸操作

| 操作 | 功能 |
|------|------|
| 单指拖拽 | 旋转视角 |
| 双指捏合 | 缩放 |
| 双指拖拽 | 平移视角 |

#### 键盘快捷键

| 按键 | 功能 |
|------|------|
| W | 切换到平移模式 |
| E | 切换到旋转模式 |
| R | 切换到缩放模式 |

## 常见问题

### Q: 为什么模型加载后看不到？

A: 尝试调用 `app.frameCurrentModel()` 自动调整相机位置。

### Q: 如何提升移动端性能？

A: 引擎会自动检测移动设备并启用优化。你也可以手动设置 `app.setSHMode(0)` 使用最快的渲染模式。

### Q: 支持哪些 PLY 格式？

A: 支持 `binary_little_endian` 和 `binary_big_endian` 格式，不支持 ASCII 格式。

### Q: WebGPU 不支持怎么办？

A: 检查浏览器版本，确保使用 HTTPS 或 localhost，检查 GPU 驱动更新。

## 许可证

MIT License
