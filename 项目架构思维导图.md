# WebGPU 3D Gaussian Splatting 渲染引擎

## 项目概述

### 核心定位

- 可扩展的 WebGPU 3D 渲染引擎
- 核心特性：3D Gaussian Splatting (3DGS) 技术
- 基于现代 Web 技术栈
- 支持桌面端和移动端

### 主要功能

- WebGPU 高性能渲染
- 3D Gaussian Splatting 支持
  - PLY 文件加载
  - GPU 加速排序（Radix Sort）
  - 球谐函数 (SH) L0/L1/L2/L3
- GLB/GLTF 模型加载
- 完整相机系统
- 内置基础几何体
- 完整 Demo 应用

### 技术亮点

- 移动端纹理压缩优化
  - 内存占用从 256 bytes/splat 降至 ~36 bytes/splat
  - 支持更大规模点云渲染
- 自适应性能等级检测
- GPU Compute Shader 加速排序
- 多级球谐函数光照

## 技术架构

### 技术栈

- 语言：TypeScript 5.3+
- 图形 API：WebGPU
- 着色器语言：WGSL (WebGPU Shading Language)
- 构建工具：Vite 5.0
- 包管理：Yarn

### 浏览器支持

- Chrome 113+
- Edge 113+
- Safari 17+
- Firefox（实验性支持）
- 要求：HTTPS 或 localhost 环境

### 系统要求

- Node.js 18+（开发环境）
- 支持 WebGPU 的现代浏览器
- GPU 硬件加速

## 项目结构

### 根目录结构

- src/ - 引擎源代码
- demo/ - Demo 应用
- gaussian/ - HLSL 着色器参考
- supersplat/ - SuperSplat 编辑器子项目
- 配置文件
  - package.json
  - tsconfig.json
  - vite.config.ts

### 核心模块 (src/)

#### 入口文件

- index.ts - 库入口，导出所有公共 API
- App.ts - 统一调度入口类（精简版，协调各子系统）

#### core/ - 核心模块

- Renderer.ts - WebGPU 渲染器
  - 设备管理
  - 渲染通道
  - 帧提交
- Camera.ts - 相机系统
  - 视图矩阵
  - 投影矩阵
  - 透视相机
- OrbitControls.ts - 轨道控制器
  - 鼠标交互
  - 相机旋转/平移/缩放
- ViewportGizmo.ts - 视口坐标轴指示器
  - 坐标轴显示
  - 视角切换
- BoundingBoxRenderer.ts - 包围盒渲染器
  - 选中对象高亮
  - 动态跟随

#### scene/ - 场景管理模块（新增）

- SceneManager.ts - 场景管理器
  - Mesh 管理
  - Splat 管理
  - Bounding Box 查询
  - 材质颜色管理

#### interaction/ - 交互管理模块（新增）

- GizmoManager.ts - Gizmo 交互管理器
  - TransformGizmo 管理
  - ViewportGizmo 管理
  - BoundingBox 渲染
  - 代理对象创建（SplatTransformProxy, MeshGroupProxy）

#### gs/ - 3D Gaussian Splatting 模块

- IGSSplatRenderer.ts - 渲染器统一接口（新增）
  - 定义桌面端/移动端共同接口
  - 消除平台判断代码
- GSSplatRenderer.ts - Splat 渲染器（桌面端）
  - 实现 IGSSplatRenderer 接口
  - 完整 SH 支持
  - 高质量渲染
- GSSplatRendererMobile.ts - Splat 渲染器（移动端）
  - 实现 IGSSplatRenderer 接口
  - 纹理压缩优化
  - 低内存占用
- GSSplatSorter.ts - GPU 排序器（桌面端）
  - Radix Sort 算法
  - Compute Shader 实现
- GSSplatSorterMobile.ts - GPU 排序器（移动端）
  - 优化的排序策略
- PLYLoader.ts - PLY 文件加载器（标准）
- PLYLoaderMobile.ts - PLY 文件加载器（移动端优化）
- SplatLoader.ts - Splat 格式加载器
- TextureCompressor.ts - 纹理压缩工具
- \*.wgsl - WGSL 着色器文件

#### mesh/ - 网格渲染模块

- Mesh.ts - 网格数据结构
- MeshRenderer.ts - 网格渲染器

#### loaders/ - 加载器模块

- GLBLoader.ts - GLB/GLTF 加载器
- OBJLoader.ts - OBJ 加载器
- OBJParser.ts - OBJ 解析器
- MTLParser.ts - MTL 材质解析器

### Demo 应用 (demo/)

- index.html - 入口 HTML
- main.ts - Demo 主逻辑
  - 场景管理
  - UI 交互
  - 文件拖放
  - 性能监控

### SuperSplat 子项目 (supersplat/)

- 独立的 3D Gaussian Splat 编辑器
- 基于 PlayCanvas 引擎
- 功能
  - 检查和编辑 3DGS
  - 优化和发布
  - 多语言支持
- 在线版本：https://superspl.at/editor

## 核心 API

### App 类（统一入口）

#### 初始化

- init() - 初始化应用
- start() - 启动渲染循环
- stop() - 停止渲染循环

#### 模型加载

- addPLY(url) - 加载 PLY 文件
  - 自动检测设备类型
  - 桌面端：标准渲染器
  - 移动端：纹理压缩渲染器
- addGLB(url) - 加载 GLB 模型
- addSplat(url) - 加载 Splat 文件

#### 测试几何体

- addTestCube() - 添加测试立方体
- addTestSphere() - 添加测试球体

#### 相机控制

- frameCurrentModel(animate) - 自动调整相机
  - 计算场景包围盒
  - 调整相机位置和视野
- getCamera() - 获取相机实例
- getControls() - 获取控制器实例

#### 渲染设置

- setSHMode(mode) - 设置球谐函数等级
  - 0 = L0（仅 DC 颜色）
  - 1 = L1（默认）
  - 2 = L2
  - 3 = L3（完整 SH）
- getSHMode() - 获取当前 SH 模式

#### 场景管理

- clearMeshes() - 清空网格
- clearSplats() - 清空 Splats
- getMeshCount() - 获取网格数量
- getSplatCount() - 获取 Splat 数量
- removeMeshByIndex(index) - 移除指定网格

#### 子系统访问

- getRenderer() - 获取渲染器
- getMeshRenderer() - 获取网格渲染器
- getGSRenderer() - 获取 GS 渲染器（桌面端）
- getGSRendererMobile() - 获取 GS 渲染器（移动端）
- getViewportGizmo() - 获取视口 Gizmo

### 导出的核心类

#### 渲染核心

- Renderer - WebGPU 设备管理
- Camera - 透视相机
- OrbitControls - 轨道控制器
- ViewportGizmo - 视口指示器

#### 网格系统

- Mesh - 网格数据结构
- MeshRenderer - 网格渲染器
- GLBLoader - GLB/GLTF 加载器

#### 3DGS 系统（桌面端）

- GSSplatRenderer - Splat 渲染器
- GSSplatSorter - GPU 排序器
- loadPLY() - PLY 加载函数

#### 3DGS 系统（移动端）

- GSSplatRendererMobile - 纹理压缩渲染器
- GSSplatSorterMobile - 优化排序器
- loadPLYMobile() - 移动端加载函数
- TextureCompressor - 纹理压缩工具

### 导出的类型定义

- SplatCPU - Splat 数据结构
- CompactSplatData - 紧凑数据格式
- SHMode - 球谐函数模式枚举
- PerformanceTier - 性能等级枚举
- BoundingBox - 包围盒类型
- MobileOptimizationConfig - 移动端优化配置

## 技术实现细节

### 3D Gaussian Splatting 原理

#### 数据结构

- 位置 (position)
- 缩放 (scale)
- 旋转 (rotation)
- 颜色 (color)
- 球谐系数 (SH coefficients)

#### 渲染流程

- 协方差矩阵计算
  - 3D 协方差投影到 2D 屏幕空间
- GPU 排序
  - Radix Sort 算法
  - Compute Shader 实现
- 基于 Quad 的渲染
  - 2D 高斯椭圆投影
- Alpha 混合
  - 深度排序后混合

#### 球谐函数 (SH)

- L0：仅 DC 颜色（最快）
- L1：一阶 SH（默认）
- L2：二阶 SH
- L3：三阶 SH（最高质量）
- 用途：视角相关的颜色变化

### 移动端优化策略

#### 纹理压缩

- 原理：将 Splat 数据存储在纹理中
- 内存优化
  - 标准格式：256 bytes/splat
  - 压缩格式：~36 bytes/splat
  - 压缩比：约 7:1
- 实现：TextureCompressor 模块

#### 性能等级检测

- HIGH：桌面高端 GPU
- MEDIUM：桌面中端 GPU
- LOW：所有移动设备
- 检测依据
  - 设备类型（UA + 触摸屏）
  - GPU Buffer 大小限制
  - 强制移动设备使用 LOW

#### 移动端配置

- 最大可见 Splat 数量限制
- 可选的排序开关
- 降低排序频率
- 紧凑数据格式
- 像素剔除阈值调整
- 默认 L0 SH 模式

### WebGPU 渲染管线

#### 初始化流程

- 检查 WebGPU 支持
- 请求 GPU 适配器
- 创建 GPU 设备
- 配置 Canvas 上下文
- 创建深度纹理

#### 渲染循环

- beginFrame() - 开始帧
  - 创建命令编码器
  - 开始渲染通道
- render() - 渲染对象
  - GS Splats 渲染
  - 网格渲染
  - Gizmo 渲染
- endFrame() - 结束帧
  - 结束渲染通道
  - 提交命令缓冲

#### 着色器系统

- WGSL 着色器
- 多个 SH 级别变体
- Compute Shader 排序
- 顶点/片段着色器

### 相机系统

#### 矩阵计算

- 视图矩阵（View Matrix）
  - LookAt 算法
  - 相机坐标系构建
- 投影矩阵（Projection Matrix）
  - 透视投影
  - FOV、近平面、远平面
- 视图投影矩阵（VP Matrix）
  - 矩阵乘法

#### 轨道控制器

- 鼠标左键：旋转视角
- 鼠标右键：平移视角
- 鼠标滚轮：缩放
- 球坐标系
  - theta（水平角）
  - phi（垂直角）
  - distance（距离）

#### 自动取景

- 计算场景包围盒
- 合并网格和点云包围盒
- 计算中心点和半径
- 调整相机位置和视野
- 支持动画过渡

## 开发者使用指南

### 快速开始

#### 安装依赖

```bash
yarn install
```

#### 启动开发服务器

```bash
yarn dev
```

访问 https://localhost:3000

#### 构建项目

```bash
# 构建 Demo
yarn build:demo

# 构建库（类型检查）
yarn build:lib
```

### 基本用法示例

#### 最简单的使用

```typescript
import { App } from "webgpu-3dgs";

const canvas = document.getElementById("canvas") as HTMLCanvasElement;
const app = new App(canvas);

await app.init();
await app.addPLY("path/to/model.ply");
app.frameCurrentModel();
app.start();
```

#### 使用单独模块

```typescript
import {
  Renderer,
  Camera,
  OrbitControls,
  GSSplatRenderer,
  loadPLY,
} from "webgpu-3dgs";

const renderer = new Renderer(canvas);
await renderer.init();

const camera = new Camera();
camera.setAspect(canvas.width / canvas.height);

const controls = new OrbitControls(camera, canvas);

const splats = await loadPLY("model.ply");
const gsRenderer = new GSSplatRenderer(renderer, camera);
gsRenderer.setData(splats);

function render() {
  const pass = renderer.beginFrame();
  gsRenderer.render(pass);
  renderer.endFrame();
  requestAnimationFrame(render);
}
render();
```

#### 加载多种格式

```typescript
// 加载 PLY（3DGS）
await app.addPLY("model.ply");

// 加载 GLB（标准 3D 模型）
await app.addGLB("model.glb");

// 加载 Splat 格式
await app.addSplat("model.splat");

// 添加测试几何体
app.addTestCube();
app.addTestSphere();
```

#### 相机控制

```typescript
// 自动取景（带动画）
app.frameCurrentModel(true);

// 获取相机和控制器
const camera = app.getCamera();
const controls = app.getControls();

// 手动设置相机
camera.fov = Math.PI / 3;
camera.near = 0.1;
camera.far = 1000;
camera.updateMatrix();

// 设置控制器
controls.distance = 10;
controls.theta = Math.PI / 4;
controls.phi = Math.PI / 4;
controls.update();
```

#### 设置渲染参数

```typescript
// 设置背景颜色
app.getRenderer().setClearColorHex("#1a1a26");

// 设置 SH 模式
app.setSHMode(2); // L2

// 获取场景信息
const meshCount = app.getMeshCount();
const splatCount = app.getSplatCount();
```

#### 场景管理

```typescript
// 清空场景
app.clearMeshes();
app.clearSplats();

// 移除特定对象
app.removeMeshByIndex(0);

// 获取特定网格
const mesh = app.getMeshByIndex(0);
```

### 移动端优化建议

#### 自动检测

- App 会自动检测设备类型
- 移动端自动使用纹理压缩渲染器
- 无需手动配置

#### 手动优化

```typescript
// 检查是否使用移动端渲染器
if (app.isUsingMobileRenderer()) {
  const mobileRenderer = app.getGSRendererMobile();
  // 移动端特定配置
}

// 移动端建议使用 L0 SH
app.setSHMode(0);
```

#### 性能监控

```typescript
// 获取性能等级
const renderer = app.getGSRenderer();
if (renderer) {
  const tier = renderer.getPerformanceTier();
  console.log("性能等级:", tier);
}
```

### 交互控制

#### 鼠标操作

- 左键拖拽：旋转视角
- 右键拖拽：平移视角
- 滚轮：缩放

#### Gizmo 交互

- 点击坐标轴：切换到正交视图
- 自动高亮当前视角

#### 文件拖放

- 支持拖放 PLY 文件
- 支持拖放 GLB 文件
- 自动识别文件类型

### 扩展开发

#### 自定义渲染器

```typescript
class CustomRenderer {
  constructor(
    private renderer: Renderer,
    private camera: Camera,
  ) {}

  render(pass: GPURenderPassEncoder) {
    // 自定义渲染逻辑
  }
}
```

#### 自定义加载器

```typescript
async function loadCustomFormat(url: string) {
  const response = await fetch(url);
  const data = await response.arrayBuffer();
  // 解析自定义格式
  return parsedData;
}
```

#### 集成到现有项目

```typescript
// 作为库使用
import { Renderer, Camera, GSSplatRenderer } from "webgpu-3dgs";

// 集成到现有渲染循环
function existingRenderLoop() {
  // 现有渲染代码
  gsRenderer.render(pass);
  // 继续现有渲染
}
```

## 性能优化建议

### 桌面端

- 使用合适的 SH 等级
  - L0：最快，适合预览
  - L1：平衡，默认选择
  - L2/L3：高质量，性能要求高
- 启用 GPU 排序
- 合理设置相机近远平面

### 移动端

- 自动使用纹理压缩
- 限制 Splat 数量
- 使用 L0 SH 模式
- 降低排序频率
- 考虑禁用排序（静态场景）

### 通用优化

- 按需加载模型
- 及时清理不用的资源
- 监控内存使用
- 使用性能分析工具

## 常见问题

### WebGPU 不支持

- 检查浏览器版本
- 确保使用 HTTPS 或 localhost
- 检查 GPU 驱动更新

### 移动端崩溃

- 模型过大（Splat 数量过多）
- 内存不足
- 建议：使用纹理压缩模式

### 渲染性能差

- 检查性能等级
- 降低 SH 等级
- 减少 Splat 数量
- 优化排序频率

### 文件加载失败

- 检查文件格式
- 确保 CORS 配置正确
- 检查文件路径

## 项目特色

### 创新点

- 完整的 WebGPU 3DGS 实现
- 移动端纹理压缩优化
- 自适应性能检测
- 模块化架构设计

### 优势

- 纯 Web 技术，无需安装
- 跨平台支持
- 高性能 GPU 加速
- 易于集成和扩展

### 应用场景

- 3D 模型预览
- 点云可视化
- 虚拟现实/增强现实
- 数字孪生
- 游戏开发
- 科学可视化

## 许可证

MIT License
